<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>QR Code Scanner (Only QR)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- QR library -->
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

<style>
body {
    margin:0; padding:16px;
    font-family:system-ui;
    background:#0f172a;
    color:#e5e7eb;
    display:flex; justify-content:center;
}
.app { width:100%; max-width:430px; }

h2 { text-align:center; margin-bottom:12px; }

#reader {
    width:100%;
    border-radius:10px;
    overflow:hidden;
}

.status {
    margin-top:14px; padding:14px;
    text-align:center; border-radius:10px;
    font-weight:700; font-size:16px;
}
.ok { background:rgba(34,197,94,0.18); color:#22c55e; }
.dup { background:rgba(239,68,68,0.18); color:#ef4444; }
.idle { background:#111827; color:#9ca3af; }

.list {
    margin-top:18px; font-size:13px;
    max-height:260px; overflow:auto;
    background:#111827; padding:10px;
    border-radius:10px;
}
.list div { padding:6px 0; border-bottom:1px solid #1f2937; }

.top-row {
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:8px;
    font-size:13px;
}
.btn-clear {
    padding:4px 10px;
    border-radius:999px;
    border:1px solid #4b5563;
    background:transparent;
    color:#9ca3af;
    cursor:pointer;
    font-size:11px;
}
.btn-clear:hover {
    background:#020617;
}
.counts {
    display:flex;
    justify-content:space-between;
    font-size:12px;
    color:#9ca3af;
    margin-top:8px;
}
.badge {
    font-weight:600;
}
</style>
</head>

<body>
<div class="app">
  <h2>QR Code Scanner (Only QR)</h2>

  <div id="reader"></div>

  <div id="statusBox" class="status idle">
      Scanner Ready
  </div>

  <div class="counts">
      <div>Total: <span id="totalCount" class="badge">0</span></div>
      <div>Unique: <span id="uniqueCount" class="badge">0</span></div>
      <div>Duplicates: <span id="dupCount" class="badge">0</span></div>
  </div>

  <div class="list" id="scanWrapper">
      <div class="top-row">
          <span>Scanned Codes (session)</span>
          <button id="clearBtn" class="btn-clear">Clear</button>
      </div>
      <div id="scanList"></div>
  </div>
</div>

<script>
// ------- SOUND -------
function beep(isDup){
    try {
        const ctx = new (window.AudioContext||window.webkitAudioContext)();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.type="square";
        osc.frequency.value = isDup ? 350 : 800;
        osc.connect(gain); gain.connect(ctx.destination);
        gain.gain.setValueAtTime(0.2, ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime+0.15);
        osc.start(); osc.stop(ctx.currentTime+0.15);
    } catch(e){}
}

// ------- VARIABLES -------
let scanned = [];        // {code, time, isDup}
let scanSet = new Set();
let lastCode = "";
let lastTime = 0;

const totalEl = document.getElementById("totalCount");
const uniqueEl = document.getElementById("uniqueCount");
const dupEl = document.getElementById("dupCount");
const statusBox = document.getElementById("statusBox");
const scanListEl = document.getElementById("scanList");
const clearBtn = document.getElementById("clearBtn");

// Load session
(function loadSession(){
    const raw = sessionStorage.getItem("qr_scans_v1");
    if(!raw) return;
    try {
        const arr = JSON.parse(raw);
        if(Array.isArray(arr)){
            scanned = arr;
            scanned.forEach(s=>{
                if(!s.isDup) scanSet.add(s.code);
            });
            updateCounts();
            renderList();
        }
    } catch(e){}
})();

function saveSession(){
    sessionStorage.setItem("qr_scans_v1", JSON.stringify(scanned));
}

function setStatus(text, type){
    statusBox.className = "status " + type;
    statusBox.textContent = text;
}

function updateCounts(){
    const total = scanned.length;
    const uniques = scanSet.size;
    const dups = scanned.filter(s=>s.isDup).length;
    totalEl.textContent = total;
    uniqueEl.textContent = uniques;
    dupEl.textContent = dups;
}

function renderList(){
    scanListEl.innerHTML = scanned.map((s,i)=>{
        const tag = s.isDup ? "DUP" : "NEW";
        const color = s.isDup ? "#fca5a5" : "#4ade80";
        return `<div>
            <strong>${i+1}.</strong> ${s.code}
            <span style="float:right; color:${color}; font-size:11px;">${tag}</span><br>
            <span style="font-size:11px; color:#9ca3af;">${s.time}</span>
        </div>`;
    }).join("");
    // auto scroll bottom
    scanListEl.parentElement.scrollTop = scanListEl.parentElement.scrollHeight;
}

clearBtn.addEventListener("click", ()=>{
    if(!confirm("Clear all scanned QR codes for this session?")) return;
    scanned = [];
    scanSet = new Set();
    saveSession();
    updateCounts();
    renderList();
    setStatus("Scanner Ready", "idle");
});

// ------- QR SCAN HANDLER -------
function onScanSuccess(qrCodeMessage) {
    const now = Date.now();
    const code = qrCodeMessage.trim();

    // debounce same QR multiple frames
    if(code === lastCode && now - lastTime < 800){
        return;
    }
    lastCode = code;
    lastTime = now;

    const isDup = scanSet.has(code);
    const timeStr = new Date().toLocaleTimeString();

    scanned.push({ code, time: timeStr, isDup });
    if(!isDup){
        scanSet.add(code);
    }

    saveSession();
    updateCounts();
    renderList();

    if(isDup){
        setStatus("Duplicate: " + code, "dup");
    } else {
        setStatus("Unique: " + code, "ok");
    }
    beep(isDup);
}

// ------- START QR SCANNER -------
const html5QrCode = new Html5Qrcode("reader");

html5QrCode.start(
    { facingMode: "environment" },   // back camera
    { fps: 15, qrbox: 250 },
    onScanSuccess,
    (errorMessage) => {
        // ignore frame errors
    }
).catch(err => {
    setStatus("Camera Error: " + err, "dup");
    console.error(err);
});
</script>

</body>
</html>
