<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>1D Barcode Scanner (Duplicates)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<!-- Quagga2 for 1D barcodes -->
<script src="https://unpkg.com/@ericblade/quagga2@1.2.6/dist/quagga.js"></script>

<style>
  body {
    margin: 0;
    padding: 16px;
    font-family: system-ui, sans-serif;
    background: #0f172a;
    color: #e5e7eb;
    display: flex;
    justify-content: center;
  }
  .app {
    width: 100%;
    max-width: 430px;
  }
  h2 {
    margin: 0 0 10px;
    text-align: center;
  }
  #camera {
    width: 100%;
    height: 260px;
    background: #000;
    border-radius: 10px;
    overflow: hidden;
  }
  #interactive video {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  .btn-row {
    display: flex;
    gap: 8px;
    margin-top: 12px;
  }
  .btn {
    flex: 1;
    padding: 10px 0;
    border-radius: 999px;
    border: none;
    cursor: pointer;
    font-weight: 600;
    font-size: 14px;
  }
  .btn-start {
    background: #22c55e;
    color: #022c22;
  }
  .btn-stop {
    background: #ef4444;
    color: #fff;
  }
  .btn-secondary {
    margin-top: 10px;
    width: 100%;
    padding: 10px 0;
    border-radius: 999px;
    border: 1px solid #4b5563;
    background: #020617;
    color: #e5e7eb;
    cursor: pointer;
    font-size: 13px;
  }
  .status {
    margin-top: 12px;
    padding: 12px;
    border-radius: 10px;
    text-align: center;
    font-weight: 700;
    font-size: 16px;
  }
  .status-idle {
    background: #111827;
    color: #9ca3af;
  }
  .status-ok {
    background: rgba(34, 197, 94, 0.18);
    color: #22c55e;
  }
  .status-dup {
    background: rgba(239, 68, 68, 0.18);
    color: #ef4444;
  }
  .status-code {
    margin-top: 4px;
    font-size: 14px;
    word-break: break-all;
    color: #e5e7eb;
  }
  .counts {
    margin-top: 10px;
    display: flex;
    justify-content: space-between;
    font-size: 13px;
    color: #9ca3af;
  }
</style>
</head>
<body>
<div class="app">
  <h2>1D Barcode Scanner (Duplicates)</h2>

  <div id="camera">
    <div id="interactive"></div>
  </div>

  <div class="btn-row">
    <button id="btnStart" class="btn btn-start">Start</button>
    <button id="btnStop" class="btn btn-stop" disabled>Stop</button>
  </div>

  <button id="btnCsv" class="btn-secondary">Download Duplicates CSV</button>
  <button id="btnClear" class="btn-secondary">Clear All</button>

  <div id="statusBox" class="status status-idle">
    <div id="statusMain">Scanner idle</div>
    <div id="statusCode" class="status-code">No scan yet.</div>
  </div>

  <div class="counts">
    <div>Total codes: <b><span id="totalCount">0</span></b></div>
    <div>Unique: <b><span id="uniqueCount">0</span></b></div>
    <div>Duplicates: <b><span id="dupCount">0</span></b></div>
  </div>
</div>

<script>
  // ---------- Simple beep ----------
  function playBeep(isDuplicate) {
    try {
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.type = "square";
      osc.frequency.value = isDuplicate ? 400 : 900;
      osc.connect(gain);
      gain.connect(ctx.destination);
      gain.gain.setValueAtTime(0.2, ctx.currentTime);
      gain.gain.exponentialRampToValueAtTime(
        0.001,
        ctx.currentTime + 0.18
      );
      osc.start();
      osc.stop(ctx.currentTime + 0.18);
    } catch (e) {
      // ignore audio errors
    }
  }

  const btnStart = document.getElementById("btnStart");
  const btnStop = document.getElementById("btnStop");
  const btnCsv = document.getElementById("btnCsv");
  const btnClear = document.getElementById("btnClear");
  const statusBox = document.getElementById("statusBox");
  const statusMain = document.getElementById("statusMain");
  const statusCode = document.getElementById("statusCode");
  const totalCountEl = document.getElementById("totalCount");
  const uniqueCountEl = document.getElementById("uniqueCount");
  const dupCountEl = document.getElementById("dupCount");

  let isRunning = false;
  // counts[code] = how many times we accepted this code:
  // 0 => not present, 1 => first time (unique), 2 => first duplicate
  // >2 are ignored (not counted / no beep / no status)
  let counts = {};
  let lastCode = null;
  let lastTime = 0;
  const SAME_CODE_DELAY = 800; // ms

  const STORAGE_KEY = "maizic_1d_counts_v2";

  function loadFromSession() {
    const raw = sessionStorage.getItem(STORAGE_KEY);
    if (!raw) return;
    try {
      counts = JSON.parse(raw) || {};
    } catch (e) {
      counts = {};
    }
    updateCountsUI();
  }

  function saveToSession() {
    sessionStorage.setItem(STORAGE_KEY, JSON.stringify(counts));
  }

  // We treat "total codes" as number of distinct barcodes,
  // "unique" = codes with count===1,
  // "duplicates" = codes with count>=2 (we cap at 2).
  function computeTotals() {
    const codes = Object.keys(counts);
    const totalCodes = codes.length;
    let unique = 0;
    let dups = 0;
    codes.forEach(code => {
      const c = counts[code];
      if (c === 1) unique++;
      else if (c >= 2) dups++; // we never let it go above 2
    });
    return { totalCodes, unique, dups };
  }

  function updateCountsUI() {
    const { totalCodes, unique, dups } = computeTotals();
    totalCountEl.textContent = totalCodes;
    uniqueCountEl.textContent = unique;
    dupCountEl.textContent = dups;
  }

  function setStatusIdle() {
    statusBox.className = "status status-idle";
    statusMain.textContent = "Scanner idle";
    statusCode.textContent = "No scan yet.";
  }

  function setStatus(code, isDuplicate) {
    statusBox.className = "status " + (isDuplicate ? "status-dup" : "status-ok");
    statusMain.textContent = isDuplicate ? "Duplicate barcode" : "New barcode";
    statusCode.textContent = code || "—";
  }

  function onDetected(result) {
    if (!result || !result.codeResult || !result.codeResult.code) return;
    const now = Date.now();
    const code = result.codeResult.code.trim();

    // Debounce same code many times in a row (while camera stays on it)
    if (lastCode === code && now - lastTime < SAME_CODE_DELAY) {
      return;
    }
    lastCode = code;
    lastTime = now;

    const prev = counts[code] || 0;

    // If already counted as duplicate once (prev >= 2), ignore.
    // No beep, no UI update, no count.
    if (prev >= 2) {
      return;
    }

    // First time scan
    if (prev === 0) {
      counts[code] = 1;
      saveToSession();
      updateCountsUI();
      setStatus(code, false);
      playBeep(false);
      return;
    }

    // Second time scan -> first duplicate (we count exactly once)
    if (prev === 1) {
      counts[code] = 2;
      saveToSession();
      updateCountsUI();
      setStatus(code, true);
      playBeep(true);
      return;
    }
  }

  function startScanner() {
    if (isRunning) return;
    isRunning = true;
    btnStart.disabled = true;
    btnStop.disabled = false;

    Quagga.init(
      {
        inputStream: {
          type: "LiveStream",
          target: document.querySelector("#interactive"),
          constraints: {
            facingMode: "environment", // back camera
            width: { ideal: 1280 },
            height: { ideal: 720 }
          }
        },
        decoder: {
          readers: [
            // ONLY 1D BARCODE TYPES – NO QR
            "code_128_reader",
            "code_39_reader",
            "ean_reader",
            "ean_8_reader",
            "upc_reader",
            "upc_e_reader",
            "itf_reader"
          ]
        },
        locate: true
      },
      function (err) {
        if (err) {
          console.error(err);
          alert("Error initializing scanner: " + err);
          isRunning = false;
          btnStart.disabled = false;
          btnStop.disabled = true;
          return;
        }
        Quagga.start();
        statusBox.className = "status status-idle";
        statusMain.textContent = "Scanning…";
        statusCode.textContent = "Point camera at 1D barcode.";
      }
    );

    Quagga.onDetected(onDetected);
  }

  function stopScanner() {
    if (!isRunning) return;
    isRunning = false;
    btnStart.disabled = false;
    btnStop.disabled = true;
    try {
      Quagga.stop();
      Quagga.offDetected(onDetected);
    } catch (e) {
      console.warn("Error stopping Quagga", e);
    }
    setStatusIdle();
  }

  function downloadDuplicatesCsv() {
    const rows = [["barcode", "scan_count"]];
    for (const code in counts) {
      const c = counts[code];
      if (c >= 2) {
        rows.push([code, String(c)]);
      }
    }
    if (rows.length === 1) {
      alert("No duplicates to export.");
      return;
    }

    const csv = rows
      .map(r => r.map(v => `"${v.replace(/"/g, '""')}"`).join(","))
      .join("\n");
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "duplicates.csv";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  function clearAll() {
    if (!confirm("Clear all scanned barcodes for this session?")) return;
    counts = {};
    saveToSession();
    updateCountsUI();
    setStatusIdle();
  }

  btnStart.addEventListener("click", startScanner);
  btnStop.addEventListener("click", stopScanner);
  btnCsv.addEventListener("click", downloadDuplicatesCsv);
  btnClear.addEventListener("click", clearAll);

  // init
  loadFromSession();
  setStatusIdle();
</script>
</body>
</html>
