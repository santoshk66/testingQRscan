<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Maizic â€“ Fast Barcode Scanner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Styles -->
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background:#0f172a;
      color:#e5e7eb;
      min-height:100vh;
      padding:16px;
    }

    .app {
      max-width:960px;
      margin:0 auto;
      background:#020617;
      border-radius:12px;
      padding:16px;
      box-shadow:0 10px 40px rgba(0,0,0,.6);
    }

    h1 { font-size:1.4rem; margin-bottom:8px; }
    .subtitle {
      font-size:.8rem;
      color:#9ca3af;
      margin-bottom:10px;
    }

    .row { display:flex; flex-wrap:wrap; gap:16px; }
    .col { flex:1 1 280px; }

    .controls-row { margin-bottom:10px; }
    .col-actions {
      display:flex;
      flex-direction:column;
      justify-content:flex-end;
    }

    label {
      font-size:.85rem;
      color:#9ca3af;
      display:block;
      margin-bottom:4px;
    }
    input, select {
      width:100%;
      border-radius:8px;
      border:1px solid #1f2937;
      padding:8px 10px;
      background:#020617;
      color:#e5e7eb;
      outline:none;
    }
    input:focus, select:focus { border-color:#22c55e; }

    .btn {
      border:none;
      border-radius:999px;
      padding:8px 14px;
      font-size:.9rem;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
      margin-right:8px;
      margin-top:8px;
    }
    .btn-primary { background:#22c55e; color:#022c22; }
    .btn-danger  { background:#ef4444; color:#fef2f2; }
    .btn-ghost   { background:transparent; border:1px solid #4b5563; color:#e5e7eb; }
    .btn[disabled] { opacity:.5; cursor:not-allowed; }

    .video-wrapper {
      position:relative;
      border-radius:12px;
      overflow:hidden;
      border:1px solid #111827;
      background:#020617;
    }
    video {
      width:100%;
      max-height:320px;
      object-fit:cover;
      background:black;
    }
    .overlay-flash {
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      opacity:0;
      pointer-events:none;
      transition:opacity .15s linear;
      font-size:3rem;
    }
    .overlay-success { background:rgba(34,197,94,.25); color:#bbf7d0; }
    .overlay-warning { background:rgba(248,113,113,.25); color:#fee2e2; }
    .overlay-flash.show { opacity:1; }

    .batch-section { margin-top:14px; }
    h2 { margin:10px 0 6px; font-size:1rem; }

    table {
      width:100%;
      border-collapse:collapse;
      font-size:.8rem;
      margin-top:6px;
      border-radius:10px;
      overflow:hidden;
      border:1px solid #111827;
    }
    thead { background:#020617; }
    th, td {
      padding:6px 8px;
      border-bottom:1px solid #111827;
      text-align:left;
      word-break:break-all;
    }
    tbody tr:nth-child(even) { background:#020617; }
    .empty-row { text-align:center; color:#6b7280; }

    .tag {
      display:inline-flex;
      padding:2px 6px;
      border-radius:999px;
      font-size:.7rem;
      background:#0f172a;
      color:#9ca3af;
    }
    .tag-dup { background:#450a0a; color:#fecaca; }

    .badge {
      display:inline-flex;
      padding:2px 8px;
      border-radius:999px;
      font-size:.75rem;
      background:#0f172a;
      color:#9ca3af;
      margin-top:4px;
    }

    /* Toast */
    .toast {
      position:fixed;
      left:50%;
      transform:translateX(-50%);
      bottom:16px;
      background:#111827;
      border-radius:999px;
      padding:8px 14px;
      box-shadow:0 10px 30px rgba(0,0,0,.6);
      display:flex;
      align-items:center;
      gap:8px;
      font-size:.8rem;
      opacity:0;
      pointer-events:none;
      transition:opacity .15s ease-in-out, transform .15s ease-in-out;
      z-index:40;
    }
    .toast.show {
      opacity:1;
      pointer-events:auto;
      transform:translateX(-50%) translateY(-4px);
    }
    .toast-success { border:1px solid #22c55e; }
    .toast-warning { border:1px solid #f97316; }
    .toast-error   { border:1px solid #ef4444; }

    /* Modal */
    .modal-backdrop {
      position:fixed;
      inset:0;
      background:rgba(15,23,42,.8);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:30;
      opacity:0;
      pointer-events:none;
      transition:opacity .15s ease-in-out;
    }
    .modal-backdrop.show {
      opacity:1;
      pointer-events:auto;
    }
    .modal {
      background:#020617;
      border-radius:12px;
      padding:16px;
      max-width:360px;
      width:100%;
      border:1px solid #1f2937;
    }
    .modal h3 { font-size:1rem; margin-bottom:8px; }
    .modal p  { font-size:.8rem; color:#9ca3af; margin-bottom:10px; }
    .modal-actions {
      display:flex;
      justify-content:flex-end;
      gap:8px;
      margin-top:8px;
    }

    .top-row-inline {
      display:flex;
      align-items:flex-end;
      gap:8px;
      flex-wrap:wrap;
    }
  </style>

  <!-- ZXing library (fallback) -->
  <script src="https://unpkg.com/@zxing/library@latest"></script>
</head>
<body>
<div class="app">
  <h1>Maizic â€“ Fast Camera Barcode Scanner</h1>
  <p class="subtitle">
    Scan 1D barcodes using your camera, detect duplicates, and save batches.
    Everything stays local in your browser (sessionStorage).
  </p>

  <!-- Controls -->
  <div class="row controls-row">
    <div class="col">
      <div class="top-row-inline">
        <div style="flex:1 1 auto;">
          <label for="scannerName">Scanner Name (optional)</label>
          <input id="scannerName" type="text" placeholder="e.g. Akash / Scanner 1" />
        </div>
        <button class="btn btn-ghost" id="clearSessionBtn">ðŸ—‘ Clear Session</button>
      </div>
      <span class="badge" id="batchInfoBadge">
        Total: 0 | Duplicates: 0 | Batches: 0
      </span>
    </div>

    <div class="col col-actions">
      <div>
        <button class="btn btn-primary" id="startCameraBtn">â–¶ Start Camera</button>
        <button class="btn btn-danger" id="stopCameraBtn" disabled>â–  Stop</button>
        <button class="btn btn-ghost" id="finishBatchBtn" disabled>
          âœ“ Finish &amp; Assign Delivery
        </button>
      </div>
    </div>
  </div>

  <!-- Video + overlay -->
  <div class="video-wrapper">
    <video id="video" muted playsinline></video>
    <div id="successOverlay" class="overlay-flash overlay-success">âœ”</div>
    <div id="warningOverlay" class="overlay-flash overlay-warning">!</div>
  </div>

  <!-- Current batch -->
  <div class="batch-section">
    <h2>Current Batch (<span id="batchCount">0</span>)</h2>
    <table>
      <thead>
      <tr>
        <th>#</th>
        <th>Barcode</th>
        <th>Format</th>
        <th>Previous Batch?</th>
      </tr>
      </thead>
      <tbody id="batchTableBody">
      <tr><td colspan="4" class="empty-row">No barcodes scanned yet.</td></tr>
      </tbody>
    </table>
  </div>
</div>

<!-- Duplicate modal (used for both current + previous batch duplicates) -->
<div id="duplicateModalBackdrop" class="modal-backdrop">
  <div class="modal">
    <h3>Duplicate Barcode Detected</h3>
    <p id="duplicateModalText"></p>
    <div class="modal-actions">
      <button class="btn btn-ghost" id="duplicateCancelBtn">Ignore / Remove</button>
      <button class="btn btn-primary" id="duplicateAddBtn">Add Duplicate</button>
    </div>
  </div>
</div>

<!-- Finish batch modal -->
<div id="finishModalBackdrop" class="modal-backdrop">
  <div class="modal">
    <h3>Assign Delivery Partner</h3>
    <p>Select the delivery partner for this batch.</p>
    <label for="partnerSelect">Delivery Partner</label>
    <select id="partnerSelect">
      <option value="">-- Select --</option>
      <option value="Flipkart">Flipkart</option>
      <option value="Amazon">Amazon</option>
      <option value="DTDC">DTDC</option>
      <option value="BlueDart">BlueDart</option>
      <option value="Other">Other</option>
    </select>
    <div class="modal-actions">
      <button class="btn btn-ghost" id="finishCancelBtn">Cancel</button>
      <button class="btn btn-primary" id="finishConfirmBtn">Save Batch</button>
    </div>
  </div>
</div>

<!-- Toast -->
<div id="toast" class="toast">
  <span id="toastText"></span>
</div>

<script>
  /* ================== STATE ================== */
  let codeReader = null;
  let videoStream = null;
  let rafId = null;

  let processingLock = false;
  let lastScannedValue = null;
  let lastScanTime = 0;

  let currentBatch = [];
  let currentCodesSet = new Set();
  let previousCodesSet = new Set();
  let allBatches = [];

  let duplicateCount = 0;    
  let totalScanCount = 0;    

  let pendingDuplicateCode = null;
  let pendingDuplicateContext = null;

  const hasNativeDetector = "BarcodeDetector" in window;
  let barcodeDetector = null;

  /* ===== STORAGE ===== */
  function loadBatchesFromStorage() {
    try {
      const raw = sessionStorage.getItem("maizic_batches") || "[]";
      allBatches = JSON.parse(raw);
      if (!Array.isArray(allBatches)) allBatches = [];
    } catch {
      allBatches = [];
    }

    previousCodesSet.clear();
    for (const batch of allBatches) {
      if (Array.isArray(batch.barcodes)) {
        for (const b of batch.barcodes) {
          if (b && b.code) previousCodesSet.add(b.code);
        }
      }
    }
  }

  function saveBatchesToStorage() {
    sessionStorage.setItem("maizic_batches", JSON.stringify(allBatches));
  }

  function updateCountsBadge() {
    const badge = document.getElementById("batchInfoBadge");
    badge.textContent =
      `Total: ${totalScanCount} | Duplicates: ${duplicateCount} | Batches: ${allBatches.length}`;
  }

  /* ===== TOAST ===== */
  let toastTimeout = null;
  function showToast(msg, variant = "success") {
    const el = document.getElementById("toast");
    const txt = document.getElementById("toastText");
    txt.textContent = msg;
    el.className = "toast show toast-" + variant;
    clearTimeout(toastTimeout);
    toastTimeout = setTimeout(() => {
      el.className = "toast";
    }, 2000);
  }

  /* ===== OVERLAY ===== */
  function flashOverlay(type) {
    const ok = document.getElementById("successOverlay");
    const warn = document.getElementById("warningOverlay");
    const target = type === "success" ? ok : warn;
    target.classList.add("show");
    setTimeout(() => target.classList.remove("show"), 150);
  }

  /* ===== RENDER TABLE ===== */
  function renderCurrentBatch() {
    const tbody = document.getElementById("batchTableBody");
    tbody.innerHTML = "";

    if (!currentBatch.length) {
      tbody.innerHTML =
        '<tr><td colspan="4" class="empty-row">No barcodes scanned yet.</td></tr>';
    } else {
      currentBatch.forEach((item, i) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${i + 1}</td>
          <td>${item.code}</td>
          <td>${item.format || "-"}</td>
          <td>${
            item.existedBefore
              ? '<span class="tag tag-dup">Yes</span>'
              : '<span class="tag">No</span>'
          }</td>`;
        tbody.appendChild(tr);
      });
    }

    document.getElementById("batchCount").textContent = String(currentBatch.length);
    document.getElementById("finishBatchBtn").disabled = currentBatch.length === 0;

    updateCountsBadge();
  }

  /* ===== SCAN HANDLER ===== */
  function existsInCurrentBatch(code) {
    return currentCodesSet.has(code);
  }
  function existsInPreviousBatches(code) {
    return previousCodesSet.has(code);
  }

  function handleBarcodeScanned(code, format) {
    if (!code) return;

    totalScanCount++;

    // DUPLICATE IN CURRENT BATCH â†’ ASK USER
    if (existsInCurrentBatch(code)) {
      pendingDuplicateCode = code;
      pendingDuplicateContext = "current";

      const count = currentBatch.filter(b => b.code === code).length;
      document.getElementById("duplicateModalText").textContent =
        `Barcode "${code}" is already scanned (${count} times). Add again or ignore?`;

      document.getElementById("duplicateModalBackdrop").classList.add("show");
      flashOverlay("warning");
      showToast("Duplicate detected", "warning");
      return;
    }

    // Add to this batch
    const existedBefore = existsInPreviousBatches(code);

    currentBatch.push({
      code,
      format: format || "native",
      existedBefore
    });
    currentCodesSet.add(code);

    playBeep("success");
    flashOverlay("success");
    showToast("Scanned: " + code);

    // DUPLICATE FROM OLD BATCHES â†’ ASK USER
    if (existedBefore) {
      pendingDuplicateCode = code;
      pendingDuplicateContext = "previous";

      document.getElementById("duplicateModalText").textContent =
        `Barcode "${code}" was scanned in a previous batch. Keep or remove?`;

      document.getElementById("duplicateModalBackdrop").classList.add("show");
      playBeep("warning");
    }

    renderCurrentBatch();
  }

  /* ===== CAMERA BOOST (NO FLASH) ===== */
  async function applyCameraBoost(track) {
    try {
      await track.applyConstraints({
        advanced: [
          { focusMode: "continuous" },
          { exposureMode: "continuous" },
          { exposureCompensation: 2 }
        ]
      });
    } catch (e) {
      console.warn("Camera boost not fully supported:", e);
    }

    // continuous refocus every 1 sec
    setInterval(async () => {
      try {
        await track.applyConstraints({
          advanced: [{ focusMode: "continuous" }]
        });
      } catch {}
    }, 1000);
  }

  /* ===== NATIVE DETECTOR ===== */
  async function startNativeScanner() {
    const video = document.getElementById("video");

    try {
      videoStream = await navigator.mediaDevices.getUserMedia({
        video: {
          facingMode: { ideal: "environment" },
          width: { ideal: 1280 },
          height: { ideal: 720 },
          frameRate: { ideal: 60, max: 60 }
        },
        audio: false
      });

      video.srcObject = videoStream;
      await video.play();

      const track = videoStream.getVideoTracks()[0];
      applyCameraBoost(track);

      const supported = BarcodeDetector.getSupportedFormats();
      const formats = [
        "code_128", "code_39", "code_93",
        "ean_13", "ean_8",
        "upc_a", "upc_e",
        "itf"
      ].filter(f => supported.includes(f));

      barcodeDetector = new BarcodeDetector({ formats });

      const detectLoop = async () => {
        try {
          const barcodes = await barcodeDetector.detect(video);
          if (barcodes.length > 0) {
            const first = barcodes[0];
            const value = first.rawValue;
            const now = Date.now();

            if (
              processingLock &&
              value === lastScannedValue &&
              now - lastScanTime < 150
            ) {} 
            else {
              processingLock = true;
              lastScannedValue = value;
              lastScanTime = now;

              handleBarcodeScanned(value, first.format);
              setTimeout(() => (processingLock = false), 100);
            }
          }
        } catch {}

        rafId = requestAnimationFrame(detectLoop);
      };

      rafId = requestAnimationFrame(detectLoop);
    } catch (err) {
      console.error("Native failed, fallback:", err);
      startZXingScanner();
    }
  }

  function stopNativeScanner() {
    if (rafId) cancelAnimationFrame(rafId);
    if (videoStream) videoStream.getTracks().forEach(t => t.stop());
    barcodeDetector = null;

    const v = document.getElementById("video");
    if (v) v.srcObject = null;
  }

  /* ===== ZXING FALLBACK ===== */
  async function startZXingScanner() {
    if (codeReader) return;

    const hints = new Map();
    hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS, [
      ZXing.BarcodeFormat.CODE_128,
      ZXing.BarcodeFormat.CODE_39,
      ZXing.BarcodeFormat.EAN_13
    ]);

    codeReader = new ZXing.BrowserMultiFormatReader(hints);

    await codeReader.decodeFromVideoDevice(null, "video", (result) => {
      if (result) {
        const now = Date.now();
        const value = result.getText();

        if (
          processingLock &&
          value === lastScannedValue &&
          now - lastScanTime < 200
        ) return;

        processingLock = true;
        lastScannedValue = value;
        lastScanTime = now;

        handleBarcodeScanned(
          value,
          result.getBarcodeFormat && result.getBarcodeFormat()
        );

        setTimeout(() => (processingLock = false), 130);
      }
    });
  }

  function stopZXingScanner() {
    if (codeReader) {
      codeReader.reset();
      codeReader = null;
    }
  }

  /* ===== CAMERA BUTTONS ===== */
  async function startCamera() {
    document.getElementById("startCameraBtn").disabled = true;
    document.getElementById("stopCameraBtn").disabled = false;

    if (hasNativeDetector) startNativeScanner();
    else startZXingScanner();
  }

  function stopCamera() {
    stopNativeScanner();
    stopZXingScanner();

    document.getElementById("startCameraBtn").disabled = false;
    document.getElementById("stopCameraBtn").disabled = true;
  }

  /* ===== FINISH BATCH ===== */
  function openFinishModal() {
    if (!currentBatch.length) {
      showToast("Scan at least one barcode.", "warning");
      return;
    }
    document.getElementById("partnerSelect").value = "";
    document.getElementById("finishModalBackdrop").classList.add("show");
  }

  function saveCurrentBatch() {
    const partner = document.getElementById("partnerSelect").value;
    if (!partner) {
      showToast("Select delivery partner.", "warning");
      return;
    }

    const scannerName = document.getElementById("scannerName").value.trim();

    const newBatch = {
      id: "batch_" + Date.now(),
      scannerName,
      partner,
      createdAt: new Date().toISOString(),
      barcodes: currentBatch
    };

    allBatches.push(newBatch);
    for (const b of currentBatch) previousCodesSet.add(b.code);

    saveBatchesToStorage();

    currentBatch = [];
    currentCodesSet.clear();
    duplicateCount = 0;
    totalScanCount = 0;

    document.getElementById("finishModalBackdrop").classList.remove("show");
    showToast("Batch saved.", "success");
    renderCurrentBatch();
  }

  /* ===== CLEAR SESSION ===== */
  function clearSession() {
    sessionStorage.clear();
    allBatches = [];
    previousCodesSet.clear();
    currentBatch = [];
    currentCodesSet.clear();
    duplicateCount = 0;
    totalScanCount = 0;

    document.getElementById("scannerName").value = "";
    renderCurrentBatch();
    showToast("Session cleared.");
  }

  /* ===== DUPLICATE MODAL ===== */
  document.getElementById("duplicateCancelBtn").addEventListener("click", () => {
    if (!pendingDuplicateCode) return;

    if (pendingDuplicateContext === "previous") {
      // remove from current batch (it was already added once)
      currentBatch = currentBatch.filter(b => b.code !== pendingDuplicateCode);
      currentCodesSet.delete(pendingDuplicateCode);
      showToast("Removed from batch", "warning");
    } else {
      showToast("Ignored duplicate", "warning");
    }

    pendingDuplicateCode = null;
    pendingDuplicateContext = null;
    document.getElementById("duplicateModalBackdrop").classList.remove("show");
    renderCurrentBatch();
  });

  document.getElementById("duplicateAddBtn").addEventListener("click", () => {
    if (!pendingDuplicateCode) return;

    if (pendingDuplicateContext === "current") {
      const existing = currentBatch.find(b => b.code === pendingDuplicateCode);
      if (existing) {
        currentBatch.push({ ...existing });
        duplicateCount++;
        showToast("Duplicate added again", "success");
      }
    } else {
      duplicateCount++;
      showToast("Duplicate kept", "success");
    }

    pendingDuplicateCode = null;
    pendingDuplicateContext = null;
    document.getElementById("duplicateModalBackdrop").classList.remove("show");
    renderCurrentBatch();
  });

  /* ===== INIT ===== */
  (function init() {
    loadBatchesFromStorage();

    const savedName = sessionStorage.getItem("maizic_scanner_name");
    if (savedName) document.getElementById("scannerName").value = savedName;

    totalScanCount = 0;
    duplicateCount = 0;

    renderCurrentBatch();
  })();
</script>
</body>
</html>
