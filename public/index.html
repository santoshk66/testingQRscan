<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>1D Barcode Scanner (Duplicates Counter)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<!-- Quagga2 for 1D barcodes -->
<script src="https://unpkg.com/@ericblade/quagga2@1.2.6/dist/quagga.js"></script>

<style>
  body {
    margin: 0;
    padding: 16px;
    font-family: system-ui, sans-serif;
    background: #0f172a;
    color: #e5e7eb;
    display: flex;
    justify-content: center;
  }
  .app {
    width: 100%;
    max-width: 430px;
  }
  h2 {
    margin: 0 0 10px;
    text-align: center;
  }
  #camera {
    width: 100%;
    height: 260px;
    background: #000;
    border-radius: 10px;
    overflow: hidden;
  }
  #interactive video {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  .btn-row {
    display: flex;
    gap: 8px;
    margin-top: 12px;
  }
  .btn {
    flex: 1;
    padding: 10px 0;
    border-radius: 999px;
    border: none;
    cursor: pointer;
    font-weight: 600;
    font-size: 14px;
  }
  .btn-start {
    background: #22c55e;
    color: #022c22;
  }
  .btn-stop {
    background: #ef4444;
    color: #fff;
  }
  .btn-export {
    margin-top: 10px;
    width: 100%;
    padding: 10px 0;
    border-radius: 999px;
    border: 1px solid #4b5563;
    background: #020617;
    color: #e5e7eb;
    cursor: pointer;
    font-size: 13px;
  }
  .status {
    margin-top: 12px;
    padding: 12px;
    border-radius: 10px;
    text-align: center;
    font-weight: 700;
    font-size: 16px;
  }
  .status-idle {
    background: #111827;
    color: #9ca3af;
  }
  .status-ok {
    background: rgba(34, 197, 94, 0.18);
    color: #22c55e;
  }
  .status-dup {
    background: rgba(239, 68, 68, 0.18);
    color: #ef4444;
  }
  .status-code {
    margin-top: 4px;
    font-size: 14px;
    word-break: break-all;
    color: #e5e7eb;
  }
  .counts {
    margin-top: 10px;
    display: flex;
    justify-content: space-between;
    font-size: 13px;
    color: #9ca3af;
  }
</style>
</head>
<body>
<div class="app">
  <h2>1D Barcode Scanner (Duplicates)</h2>

  <div id="camera">
    <div id="interactive"></div>
  </div>

  <div class="btn-row">
    <button id="btnStart" class="btn btn-start">Start</button>
    <button id="btnStop" class="btn btn-stop" disabled>Stop</button>
  </div>

  <button id="btnCsv" class="btn-export">Download Duplicates CSV</button>

  <div id="statusBox" class="status status-idle">
    Scanner idle
    <div id="statusCode" class="status-code">No scan yet.</div>
  </div>

  <div class="counts">
    <div>Total scans: <b><span id="totalCount">0</span></b></div>
    <div>Unique: <b><span id="uniqueCount">0</span></b></div>
    <div>Duplicates: <b><span id="dupCount">0</span></b></div>
  </div>
</div>

<script>
  // ---------- Simple beep ----------
  function playBeep(isDuplicate) {
    try {
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.type = "square";
      osc.frequency.value = isDuplicate ? 400 : 900;
      osc.connect(gain);
      gain.connect(ctx.destination);
      gain.gain.setValueAtTime(0.2, ctx.currentTime);
      gain.gain.exponentialRampToValueAtTime(
        0.001,
        ctx.currentTime + 0.18
      );
      osc.start();
      osc.stop(ctx.currentTime + 0.18);
    } catch (e) {
      // ignore audio errors
    }
  }

  const btnStart = document.getElementById("btnStart");
  const btnStop = document.getElementById("btnStop");
  const btnCsv = document.getElementById("btnCsv");
  const statusBox = document.getElementById("statusBox");
  const statusCode = document.getElementById("statusCode");
  const totalCountEl = document.getElementById("totalCount");
  const uniqueCountEl = document.getElementById("uniqueCount");
  const dupCountEl = document.getElementById("dupCount");

  let isRunning = false;
  let counts = {};      // code -> total scan count
  let lastCode = null;
  let lastTime = 0;
  const SAME_CODE_DELAY = 800; // ms

  const STORAGE_KEY = "maizic_1d_counts_v1";

  function loadFromSession() {
    const raw = sessionStorage.getItem(STORAGE_KEY);
    if (!raw) return;
    try {
      counts = JSON.parse(raw) || {};
    } catch (e) {
      counts = {};
    }
    updateCountsUI();
  }

  function saveToSession() {
    sessionStorage.setItem(STORAGE_KEY, JSON.stringify(counts));
  }

  function computeTotals() {
    let totalScans = 0;
    let uniqueCodes = 0;
    let totalDuplicates = 0;
    for (const code in counts) {
      const c = counts[code];
      totalScans += c;
      uniqueCodes += 1;
      if (c > 1) totalDuplicates += (c - 1);
    }
    return { totalScans, uniqueCodes, totalDuplicates };
  }

  function updateCountsUI() {
    const { totalScans, uniqueCodes, totalDuplicates } = computeTotals();
    totalCountEl.textContent = totalScans;
    uniqueCountEl.textContent = uniqueCodes;
    dupCountEl.textContent = totalDuplicates;
  }

  function setStatusIdle() {
    statusBox.className = "status status-idle";
    statusBox.firstChild && (statusBox.firstChild.textContent = "Scanner idle");
    statusCode.textContent = "No scan yet.";
  }

  function setStatus(code, isDuplicate) {
    statusBox.className = "status " + (isDuplicate ? "status-dup" : "status-ok");
    statusBox.firstChild && (statusBox.firstChild.textContent =
      isDuplicate ? "Duplicate barcode" : "New barcode");
    statusCode.textContent = code || "—";
  }

  function onDetected(result) {
    if (!result || !result.codeResult || !result.codeResult.code) return;
    const now = Date.now();
    const code = result.codeResult.code.trim();

    // debounce same code many times in a row
    if (lastCode === code && now - lastTime < SAME_CODE_DELAY) {
      return;
    }
    lastCode = code;
    lastTime = now;

    // update counts
    if (!counts[code]) counts[code] = 0;
    counts[code] += 1;

    const isDuplicate = counts[code] > 1;
    saveToSession();
    updateCountsUI();
    setStatus(code, isDuplicate);
    playBeep(isDuplicate);
  }

  function startScanner() {
    if (isRunning) return;
    isRunning = true;
    btnStart.disabled = true;
    btnStop.disabled = false;

    Quagga.init(
      {
        inputStream: {
          type: "LiveStream",
          target: document.querySelector("#interactive"),
          constraints: {
            facingMode: "environment", // back camera
            width: { ideal: 1280 },
            height: { ideal: 720 }
          }
        },
        decoder: {
          readers: [
            // ONLY 1D BARCODE TYPES – NO QR
            "code_128_reader",
            "code_39_reader",
            "ean_reader",
            "ean_8_reader",
            "upc_reader",
            "upc_e_reader",
            "itf_reader"
          ]
        },
        locate: true
      },
      function (err) {
        if (err) {
          console.error(err);
          alert("Error initializing scanner: " + err);
          isRunning = false;
          btnStart.disabled = false;
          btnStop.disabled = true;
          return;
        }
        Quagga.start();
        statusBox.className = "status status-idle";
        statusBox.firstChild && (statusBox.firstChild.textContent = "Scanning…");
        statusCode.textContent = "Point camera at 1D barcode.";
      }
    );

    Quagga.onDetected(onDetected);
  }

  function stopScanner() {
    if (!isRunning) return;
    isRunning = false;
    btnStart.disabled = false;
    btnStop.disabled = true;
    try {
      Quagga.stop();
      Quagga.offDetected(onDetected);
    } catch (e) {
      console.warn("Error stopping Quagga", e);
    }
    setStatusIdle();
  }

  function downloadDuplicatesCsv() {
    // Build rows only for codes with count > 1
    const rows = [["barcode", "total_scans", "duplicate_scans"]];
    for (const code in counts) {
      const c = counts[code];
      if (c > 1) {
        rows.push([code, String(c), String(c - 1)]);
      }
    }
    if (rows.length === 1) {
      alert("No duplicates to export.");
      return;
    }

    const csv = rows.map(r => r.map(v => `"${v.replace(/"/g, '""')}"`).join(",")).join("\n");
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "duplicates.csv";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  btnStart.addEventListener("click", startScanner);
  btnStop.addEventListener("click", stopScanner);
  btnCsv.addEventListener("click", downloadDuplicatesCsv);

  // init
  loadFromSession();
  setStatusIdle();
</script>
</body>
</html>
