<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Maizic â€“ Fast Barcode Scanner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Styles -->
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background:#0f172a;
      color:#e5e7eb;
      min-height:100vh;
      padding:16px;
    }

    .app {
      max-width:960px;
      margin:0 auto;
      background:#020617;
      border-radius:12px;
      padding:16px;
      box-shadow:0 10px 40px rgba(0,0,0,.6);
    }

    h1 { font-size:1.4rem; margin-bottom:8px; }
    .subtitle {
      font-size:.8rem;
      color:#9ca3af;
      margin-bottom:10px;
    }

    .row { display:flex; flex-wrap:wrap; gap:16px; }
    .col { flex:1 1 280px; }

    .controls-row { margin-bottom:10px; }
    .col-actions {
      display:flex;
      flex-direction:column;
      justify-content:flex-end;
    }

    label {
      font-size:.85rem;
      color:#9ca3af;
      display:block;
      margin-bottom:4px;
    }
    input, select {
      width:100%;
      border-radius:8px;
      border:1px solid #1f2937;
      padding:8px 10px;
      background:#020617;
      color:#e5e7eb;
      outline:none;
    }
    input:focus, select:focus { border-color:#22c55e; }

    .btn {
      border:none;
      border-radius:999px;
      padding:8px 14px;
      font-size:.9rem;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
      margin-right:8px;
      margin-top:8px;
    }
    .btn-primary { background:#22c55e; color:#022c22; }
    .btn-danger  { background:#ef4444; color:#fef2f2; }
    .btn-ghost   { background:transparent; border:1px solid #4b5563; color:#e5e7eb; }
    .btn[disabled] { opacity:.5; cursor:not-allowed; }

    .video-wrapper {
      position:relative;
      border-radius:12px;
      overflow:hidden;
      border:1px solid #111827;
      background:#020617;
    }
    video {
      width:100%;
      max-height:320px;
      object-fit:cover;
      background:black;
    }
    .overlay-flash {
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      opacity:0;
      pointer-events:none;
      transition:opacity .15s linear;
      font-size:3rem;
    }
    .overlay-success { background:rgba(34,197,94,.25); color:#bbf7d0; }
    .overlay-warning { background:rgba(248,113,113,.25); color:#fee2e2; }
    .overlay-flash.show { opacity:1; }

    .batch-section { margin-top:14px; }
    h2 { margin:10px 0 6px; font-size:1rem; }

    table {
      width:100%;
      border-collapse:collapse;
      font-size:.8rem;
      margin-top:6px;
      border-radius:10px;
      overflow:hidden;
      border:1px solid #111827;
    }
    thead { background:#020617; }
    th, td {
      padding:6px 8px;
      border-bottom:1px solid #111827;
      text-align:left;
      word-break:break-all;
    }
    tbody tr:nth-child(even) { background:#020617; }
    .empty-row { text-align:center; color:#6b7280; }

    .tag {
      display:inline-flex;
      padding:2px 6px;
      border-radius:999px;
      font-size:.7rem;
      background:#0f172a;
      color:#9ca3af;
    }
    .tag-dup { background:#450a0a; color:#fecaca; }

    .badge {
      display:inline-flex;
      padding:2px 8px;
      border-radius:999px;
      font-size:.75rem;
      background:#0f172a;
      color:#9ca3af;
      margin-top:4px;
    }

    /* Toast */
    .toast {
      position:fixed;
      left:50%;
      transform:translateX(-50%);
      bottom:16px;
      background:#111827;
      border-radius:999px;
      padding:8px 14px;
      box-shadow:0 10px 30px rgba(0,0,0,.6);
      display:flex;
      align-items:center;
      gap:8px;
      font-size:.8rem;
      opacity:0;
      pointer-events:none;
      transition:opacity .15s ease-in-out, transform .15s ease-in-out;
      z-index:40;
    }
    .toast.show {
      opacity:1;
      pointer-events:auto;
      transform:translateX(-50%) translateY(-4px);
    }
    .toast-success { border:1px solid #22c55e; }
    .toast-warning { border:1px solid #f97316; }
    .toast-error   { border:1px solid #ef4444; }

    /* Modal */
    .modal-backdrop {
      position:fixed;
      inset:0;
      background:rgba(15,23,42,.8);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:30;
      opacity:0;
      pointer-events:none;
      transition:opacity .15s ease-in-out;
    }
    .modal-backdrop.show {
      opacity:1;
      pointer-events:auto;
    }
    .modal {
      background:#020617;
      border-radius:12px;
      padding:16px;
      max-width:360px;
      width:100%;
      border:1px solid #1f2937;
    }
    .modal h3 { font-size:1rem; margin-bottom:8px; }
    .modal p  { font-size:.8rem; color:#9ca3af; margin-bottom:10px; }
    .modal-actions {
      display:flex;
      justify-content:flex-end;
      gap:8px;
      margin-top:8px;
    }

    .top-row-inline {
      display:flex;
      align-items:flex-end;
      gap:8px;
      flex-wrap:wrap;
    }
  </style>

  <!-- ZXing library (camera decoding only, no data sent to server) -->
  <script src="https://unpkg.com/@zxing/library@latest"></script>
</head>
<body>
<div class="app">
  <h1>Maizic â€“ Fast Camera Barcode Scanner</h1>
  <p class="subtitle">
    Scan 1D barcodes using your camera, detect duplicates, and save batches.
    Everything stays local in your browser (sessionStorage).
  </p>

  <!-- Controls -->
  <div class="row controls-row">
    <div class="col">
      <div class="top-row-inline">
        <div style="flex:1 1 auto;">
          <label for="scannerName">Scanner Name (optional)</label>
          <input id="scannerName" type="text" placeholder="e.g. Akash / Scanner 1" />
        </div>
        <button class="btn btn-ghost" id="clearSessionBtn">ðŸ—‘ Clear Session</button>
      </div>
      <span class="badge" id="batchInfoBadge">Saved batches: 0</span>
    </div>

    <div class="col col-actions">
      <div>
        <button class="btn btn-primary" id="startCameraBtn">â–¶ Start Camera</button>
        <button class="btn btn-danger" id="stopCameraBtn" disabled>â–  Stop</button>
        <button class="btn btn-ghost" id="finishBatchBtn" disabled>
          âœ“ Finish &amp; Assign Delivery
        </button>
      </div>
    </div>
  </div>

  <!-- Video + overlay -->
  <div class="video-wrapper">
    <video id="video" muted playsinline></video>
    <div id="successOverlay" class="overlay-flash overlay-success">âœ”</div>
    <div id="warningOverlay" class="overlay-flash overlay-warning">!</div>
  </div>

  <!-- Current batch -->
  <div class="batch-section">
    <h2>Current Batch (<span id="batchCount">0</span>)</h2>
    <table>
      <thead>
      <tr>
        <th>#</th>
        <th>Barcode</th>
        <th>Format</th>
        <th>Previous Batch?</th>
      </tr>
      </thead>
      <tbody id="batchTableBody">
      <tr><td colspan="4" class="empty-row">No barcodes scanned yet.</td></tr>
      </tbody>
    </table>
  </div>
</div>

<!-- Duplicate cross-batch modal -->
<div id="duplicateModalBackdrop" class="modal-backdrop">
  <div class="modal">
    <h3>Duplicate Found in Previous Batch</h3>
    <p id="duplicateModalText"></p>
    <div class="modal-actions">
      <button class="btn btn-ghost" id="duplicateCancelBtn">Cancel (Remove)</button>
      <button class="btn btn-primary" id="duplicateAddBtn">Add Anyway</button>
    </div>
  </div>
</div>

<!-- Finish batch modal -->
<div id="finishModalBackdrop" class="modal-backdrop">
  <div class="modal">
    <h3>Assign Delivery Partner</h3>
    <p>Select the delivery partner for this batch.</p>
    <label for="partnerSelect">Delivery Partner</label>
    <select id="partnerSelect">
      <option value="">-- Select --</option>
      <option value="Flipkart">Flipkart</option>
      <option value="Amazon">Amazon</option>
      <option value="DTDC">DTDC</option>
      <option value="BlueDart">BlueDart</option>
      <option value="Other">Other</option>
    </select>
    <div class="modal-actions">
      <button class="btn btn-ghost" id="finishCancelBtn">Cancel</button>
      <button class="btn btn-primary" id="finishConfirmBtn">Save Batch</button>
    </div>
  </div>
</div>

<!-- Toast -->
<div id="toast" class="toast">
  <span id="toastText"></span>
</div>

<!-- JS -->
<script>
  // ====== STATE ======
  let codeReader = null;         // ZXing instance (fallback)
  let videoStream = null;        // MediaStream for native detector
  let rafId = null;              // requestAnimationFrame id

  let processingLock = false;
  let lastScannedValue = null;
  let lastScanTime = 0;

  let currentBatch = [];            // {code, format, existedBefore}
  let currentCodesSet = new Set();  // fast duplicate check in current batch
  let previousCodesSet = new Set(); // fast duplicate check across saved batches

  let allBatches = [];              // in-memory list of all saved batches

  let pendingDuplicateCode = null;

  // Prefer native BarcodeDetector when available
  const hasNativeDetector = "BarcodeDetector" in window;
  let barcodeDetector = null;

  // ====== STORAGE (sessionStorage only) ======
  function loadBatchesFromStorage() {
    try {
      const raw = sessionStorage.getItem("maizic_batches") || "[]";
      allBatches = JSON.parse(raw);
      if (!Array.isArray(allBatches)) allBatches = [];
    } catch {
      allBatches = [];
    }

    // Rebuild previousCodesSet for fast lookup
    previousCodesSet.clear();
    for (const batch of allBatches) {
      if (batch.barcodes && Array.isArray(batch.barcodes)) {
        for (const b of batch.barcodes) {
          if (b && b.code) previousCodesSet.add(b.code);
        }
      }
    }
  }

  function saveBatchesToStorage() {
    sessionStorage.setItem("maizic_batches", JSON.stringify(allBatches));
    updateBatchBadge();
  }

  function updateBatchBadge() {
    const badge = document.getElementById("batchInfoBadge");
    badge.textContent = `Saved batches: ${allBatches.length}`;
  }

  // ====== AUDIO ======
  function playBeep(type) {
    try {
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.connect(gain);
      gain.connect(ctx.destination);

      if (type === "success") osc.frequency.value = 900;
      else if (type === "warning") osc.frequency.value = 350;
      else osc.frequency.value = 600;

      gain.gain.value = 0.15;
      osc.start();
      setTimeout(() => { osc.stop(); ctx.close(); }, type === "warning" ? 250 : 120);
    } catch {}
  }

  // ====== TOAST ======
  let toastTimeout = null;
  function showToast(msg, variant = "success") {
    const el = document.getElementById("toast");
    const txt = document.getElementById("toastText");
    txt.textContent = msg;
    el.className = "toast show toast-" + variant;
    clearTimeout(toastTimeout);
    toastTimeout = setTimeout(() => { el.className = "toast"; }, 2200);
  }

  // ====== OVERLAY ======
  function flashOverlay(type) {
    const success = document.getElementById("successOverlay");
    const warning = document.getElementById("warningOverlay");
    const target = type === "success" ? success : warning;
    target.classList.add("show");
    setTimeout(() => target.classList.remove("show"), 150);
  }

  // ====== BATCH RENDER ======
  function renderCurrentBatch() {
    const tbody = document.getElementById("batchTableBody");
    tbody.innerHTML = "";

    if (!currentBatch.length) {
      tbody.innerHTML =
        '<tr><td colspan="4" class="empty-row">No barcodes scanned yet.</td></tr>';
    } else {
      currentBatch.forEach((item, i) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${i + 1}</td>
          <td>${item.code}</td>
          <td>${item.format || "-"}</td>
          <td>${
            item.existedBefore
              ? '<span class="tag tag-dup">Yes</span>'
              : '<span class="tag">No</span>'
          }</td>
        `;
        tbody.appendChild(tr);
      });
    }

    document.getElementById("batchCount").textContent = String(currentBatch.length);
    const finishBtn = document.getElementById("finishBatchBtn");
    // Scanner name optional -> only need at least one barcode
    finishBtn.disabled = !(currentBatch.length);
  }

  function existsInCurrentBatch(code) {
    return currentCodesSet.has(code);
  }
  function existsInPreviousBatches(code) {
    return previousCodesSet.has(code);
  }

  // ====== SCAN HANDLER ======
  function handleBarcodeScanned(code, format) {
    if (!code) return;

    if (existsInCurrentBatch(code)) {
      // Duplicate in current batch -> warn & ignore
      showToast("Duplicate in current batch â€“ ignored.", "warning");
      playBeep("warning");
      flashOverlay("warning");
      return;
    }

    const existedBefore = existsInPreviousBatches(code);

    currentBatch.push({ code, format, existedBefore });
    currentCodesSet.add(code);
    renderCurrentBatch();
    playBeep("success");
    flashOverlay("success");
    showToast("Scanned: " + code, "success");

    if (existedBefore) {
      pendingDuplicateCode = code;
      document.getElementById("duplicateModalText").textContent =
        `Barcode "${code}" has been scanned in an earlier batch. Do you want to keep it in the current batch?`;
      document.getElementById("duplicateModalBackdrop").classList.add("show");
      playBeep("warning");
    }
  }

  // ====== NATIVE BARCODEDETECTOR PATH (fast, 1D only) ======
  async function startNativeScanner() {
    const video = document.getElementById("video");

    try {
      // Lower resolution => faster detection
      videoStream = await navigator.mediaDevices.getUserMedia({
        video: {
          facingMode: { ideal: "environment" },
          width: { ideal: 640, max: 640 },
          height: { ideal: 480, max: 480 },
          frameRate: { ideal: 30, max: 30 }
        },
        audio: false
      });

      video.srcObject = videoStream;
      await video.play();

      // Try to hint continuous focus if supported (browser dependent)
      const tracks = videoStream.getVideoTracks();
      if (tracks[0] && tracks[0].applyConstraints) {
        tracks[0].applyConstraints({
          advanced: [{ focusMode: "continuous" }]
        }).catch(() => {});
      }

      const formats = [
        "code_128",
        "code_39",
        "code_93",
        "ean_13",
        "ean_8",
        "upc_a",
        "upc_e",
        "itf" // 1D only, no QR
      ].filter(f => BarcodeDetector.getSupportedFormats().includes(f));

      barcodeDetector = new BarcodeDetector({ formats });

      const scanLoop = async () => {
        if (!barcodeDetector) return;

        try {
          const barcodes = await barcodeDetector.detect(video);
          if (barcodes && barcodes.length > 0) {
            const first = barcodes[0];
            const value = first.rawValue;
            const now = Date.now();

            // Aggressive debouncing: very short lock for speed
            if (
              processingLock &&
              value === lastScannedValue &&
              now - lastScanTime < 180
            ) {
              // ignore same-frame duplicate
            } else {
              processingLock = true;
              lastScannedValue = value;
              lastScanTime = now;

              handleBarcodeScanned(value, first.format || "native");

              setTimeout(() => { processingLock = false; }, 110);
            }
          }
        } catch (e) {
          console.error("BarcodeDetector error:", e);
        }

        rafId = requestAnimationFrame(scanLoop);
      };

      rafId = requestAnimationFrame(scanLoop);
    } catch (e) {
      console.error("Native scanner failed, falling back to ZXing:", e);
      showToast("Native scanner not available, using fallback.", "warning");
      startZXingScanner();
    }
  }

  function stopNativeScanner() {
    if (rafId) {
      cancelAnimationFrame(rafId);
      rafId = null;
    }
    if (videoStream) {
      videoStream.getTracks().forEach(t => t.stop());
      videoStream = null;
    }
    const video = document.getElementById("video");
    if (video) {
      video.srcObject = null;
    }
    barcodeDetector = null;
  }

  // ====== ZXING PATH (fallback, 1D only) ======
  async function startZXingScanner() {
    if (codeReader) return;

    // Limit ZXing to 1D formats only for speed
    const hints = new Map();
    if (ZXing && ZXing.DecodeHintType && ZXing.BarcodeFormat) {
      hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS, [
        ZXing.BarcodeFormat.CODE_128,
        ZXing.BarcodeFormat.CODE_39,
        ZXing.BarcodeFormat.CODE_93,
        ZXing.BarcodeFormat.EAN_13,
        ZXing.BarcodeFormat.EAN_8,
        ZXing.BarcodeFormat.UPC_A,
        ZXing.BarcodeFormat.UPC_E,
        ZXing.BarcodeFormat.ITF
      ]);
      hints.set(ZXing.DecodeHintType.TRY_HARDER, true);
      codeReader = new ZXing.BrowserMultiFormatReader(hints);
    } else {
      codeReader = new ZXing.BrowserMultiFormatReader();
    }

    try {
      await codeReader.decodeFromVideoDevice(null, "video", (result, err) => {
        if (result) {
          const now = Date.now();
          const value = result.getText();
          if (
            processingLock &&
            value === lastScannedValue &&
            now - lastScanTime < 200
          ) {
            return;
          }

          processingLock = true;
          lastScannedValue = value;
          lastScanTime = now;

          handleBarcodeScanned(
            value,
            result.getBarcodeFormat && result.getBarcodeFormat()
          );

          setTimeout(() => { processingLock = false; }, 130);
        }
      });
    } catch (e) {
      console.error(e);
      showToast("Could not start camera. Check permissions.", "error");
      if (codeReader) {
        codeReader.reset();
        codeReader = null;
      }
    }
  }

  function stopZXingScanner() {
    if (codeReader) {
      codeReader.reset();
      codeReader = null;
    }
  }

  // ====== PUBLIC CAMERA FUNCTIONS ======
  async function startCamera() {
    document.getElementById("startCameraBtn").disabled = true;
    document.getElementById("stopCameraBtn").disabled = false;

    if (hasNativeDetector && navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
      await startNativeScanner();
    } else {
      await startZXingScanner();
    }
  }

  function stopCamera() {
    if (hasNativeDetector) {
      stopNativeScanner();
    }
    stopZXingScanner();

    document.getElementById("startCameraBtn").disabled = false;
    document.getElementById("stopCameraBtn").disabled = true;
  }

  // ====== FINISH BATCH ======
  function openFinishModal() {
    if (!currentBatch.length) {
      showToast("Scan at least one barcode.", "warning");
      return;
    }
    document.getElementById("partnerSelect").value = "";
    document.getElementById("finishModalBackdrop").classList.add("show");
  }

  function saveCurrentBatch() {
    const partner = document.getElementById("partnerSelect").value;
    const scannerName = document.getElementById("scannerName").value.trim();
    if (!partner) {
      showToast("Select a delivery partner.", "warning");
      return;
    }

    const newBatch = {
      id: "batch_" + Date.now(),
      scannerName, // may be empty (optional)
      partner,
      createdAt: new Date().toISOString(),
      barcodes: currentBatch,
    };
    allBatches.push(newBatch);

    // Update previousCodesSet with new codes so future scans know about them
    for (const b of currentBatch) {
      if (b && b.code) previousCodesSet.add(b.code);
    }

    saveBatchesToStorage();

    currentBatch = [];
    currentCodesSet.clear();
    renderCurrentBatch();
    document.getElementById("finishModalBackdrop").classList.remove("show");
    showToast("Batch saved successfully.", "success");
    playBeep("success");
  }

  // ====== CLEAR SESSION ======
  function clearSession() {
    sessionStorage.removeItem("maizic_batches");
    sessionStorage.removeItem("maizic_scanner_name");
    allBatches = [];
    previousCodesSet.clear();
    currentBatch = [];
    currentCodesSet.clear();
    renderCurrentBatch();
    updateBatchBadge();
    document.getElementById("scannerName").value = "";
    showToast("Session cleared (batches + name).", "success");
  }

  // ====== EVENTS ======
  document.getElementById("startCameraBtn").addEventListener("click", startCamera);
  document.getElementById("stopCameraBtn").addEventListener("click", stopCamera);
  document.getElementById("finishBatchBtn").addEventListener("click", openFinishModal);
  document.getElementById("clearSessionBtn").addEventListener("click", clearSession);

  document.getElementById("finishCancelBtn").addEventListener("click", () => {
    document.getElementById("finishModalBackdrop").classList.remove("show");
  });
  document.getElementById("finishConfirmBtn").addEventListener("click", saveCurrentBatch);

  document.getElementById("duplicateCancelBtn").addEventListener("click", () => {
    if (pendingDuplicateCode) {
      currentBatch = currentBatch.filter((b) => b.code !== pendingDuplicateCode);
      currentCodesSet.delete(pendingDuplicateCode);
      renderCurrentBatch();
    }
    pendingDuplicateCode = null;
    document.getElementById("duplicateModalBackdrop").classList.remove("show");
    showToast("Duplicate removed from current batch.", "warning");
  });
  document.getElementById("duplicateAddBtn").addEventListener("click", () => {
    pendingDuplicateCode = null;
    document.getElementById("duplicateModalBackdrop").classList.remove("show");
    showToast("Duplicate kept in current batch.", "success");
  });

  document.getElementById("scannerName").addEventListener("input", (e) => {
    sessionStorage.setItem("maizic_scanner_name", e.target.value.trim());
  });

  // ====== INIT ======
  (function init() {
    loadBatchesFromStorage();
    updateBatchBadge();

    const savedName = sessionStorage.getItem("maizic_scanner_name");
    if (savedName) document.getElementById("scannerName").value = savedName;

    renderCurrentBatch();
  })();
</script>
</body>
</html>
