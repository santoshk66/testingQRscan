<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>1D Barcode Scanner (Duplicates)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<!-- Quagga2 for barcode scanning -->
<script src="https://unpkg.com/@ericblade/quagga2@1.2.6/dist/quagga.js"></script>

<style>
  body {
    margin: 0;
    padding: 16px;
    font-family: system-ui, sans-serif;
    background: #0f172a;
    color: #e5e7eb;
    display: flex;
    justify-content: center;
  }
  .app {
    width: 100%;
    max-width: 430px;
  }
  h2 {
    margin: 0 0 10px;
    text-align: center;
  }
  #camera {
    width: 100%;
    height: 260px;
    background: #000;
    border-radius: 10px;
    overflow: hidden;
  }
  #interactive video {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  .btn-row {
    display: flex;
    gap: 8px;
    margin-top: 12px;
  }
  .btn {
    flex: 1;
    padding: 10px 0;
    border-radius: 999px;
    border: none;
    cursor: pointer;
    font-weight: 600;
    font-size: 14px;
  }
  .btn-start {
    background: #22c55e;
    color: #022c22;
  }
  .btn-stop {
    background: #ef4444;
    color: #fff;
  }
  .btn-secondary {
    margin-top: 10px;
    width: 100%;
    padding: 10px 0;
    border-radius: 999px;
    border: 1px solid #4b5563;
    background: #020617;
    color: #e5e7eb;
    cursor: pointer;
    font-size: 13px;
  }
  .status {
    margin-top: 12px;
    padding: 12px;
    border-radius: 10px;
    text-align: center;
    font-weight: 700;
    font-size: 16px;
  }
  .status-idle {
    background: #111827;
    color: #9ca3af;
  }
  .status-ok {
    background: rgba(34, 197, 94, 0.18);
    color: #22c55e;
  }
  .status-dup {
    background: rgba(239, 68, 68, 0.18);
    color: #ef4444;
  }
  .status-code {
    margin-top: 4px;
    font-size: 14px;
    word-break: break-all;
    color: #e5e7eb;
  }
  .counts {
    margin-top: 10px;
    display: flex;
    justify-content: space-between;
    font-size: 13px;
    color: #9ca3af;
  }
</style>
</head>
<body>
<div class="app">
  <h2>1D Barcode Scanner (Duplicates)</h2>

  <div id="camera">
    <div id="interactive"></div>
  </div>

  <div class="btn-row">
    <button id="btnStart" class="btn btn-start">Start</button>
    <button id="btnStop" class="btn btn-stop" disabled>Stop</button>
  </div>

  <button id="btnShowDup" class="btn-secondary">Show Duplicate Codes</button>
  <button id="btnClear" class="btn-secondary">Clear All</button>

  <div id="statusBox" class="status status-idle">
    <div id="statusMain">Scanner idle</div>
    <div id="statusCode" class="status-code">No scan yet.</div>
  </div>

  <div class="counts">
    <div>Total barcodes: <b><span id="totalCount">0</span></b></div>
    <div>Unique: <b><span id="uniqueCount">0</span></b></div>
    <div>Duplicates: <b><span id="dupCount">0</span></b></div>
  </div>
</div>

<script>
  // ---------- Simple beep ----------
  function playBeep(isDuplicate) {
    try {
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.type = "square";
      osc.frequency.value = isDuplicate ? 400 : 900;
      osc.connect(gain);
      gain.connect(ctx.destination);
      gain.gain.setValueAtTime(0.2, ctx.currentTime);
      gain.gain.exponentialRampToValueAtTime(
        0.001,
        ctx.currentTime + 0.18
      );
      osc.start();
      osc.stop(ctx.currentTime + 0.18);
    } catch (e) {
      // ignore audio errors
    }
  }

  const btnStart = document.getElementById("btnStart");
  const btnStop  = document.getElementById("btnStop");
  const btnShowDup = document.getElementById("btnShowDup");
  const btnClear = document.getElementById("btnClear");

  const statusBox  = document.getElementById("statusBox");
  const statusMain = document.getElementById("statusMain");
  const statusCode = document.getElementById("statusCode");

  const totalCountEl  = document.getElementById("totalCount");
  const uniqueCountEl = document.getElementById("uniqueCount");
  const dupCountEl    = document.getElementById("dupCount");

  let isRunning = false;

  // counts[code] = accepted scans:
  // 0 or undefined => never scanned
  // 1 => first time (unique)
  // 2 => one duplicate (second time)
  // >2 => we ignore further scans for this code
  let counts = {};

  let lastCode = null;
  let lastTime = 0;
  const SAME_CODE_DELAY = 800; // ms

  const STORAGE_KEY = "maizic_1d_counts_v3";

  function loadFromSession() {
    const raw = sessionStorage.getItem(STORAGE_KEY);
    if (!raw) return;
    try {
      counts = JSON.parse(raw) || {};
    } catch (e) {
      counts = {};
    }
    updateCountsUI();
  }

  function saveToSession() {
    sessionStorage.setItem(STORAGE_KEY, JSON.stringify(counts));
  }

  function computeTotals() {
    const keys = Object.keys(counts);
    const totalBarcodes = keys.length;
    let unique = 0;
    let dups = 0;
    keys.forEach(code => {
      const c = counts[code];
      if (c === 1) unique++;
      else if (c >= 2) dups++;
    });
    return { totalBarcodes, unique, dups };
  }

  function updateCountsUI() {
    const { totalBarcodes, unique, dups } = computeTotals();
    totalCountEl.textContent  = totalBarcodes;
    uniqueCountEl.textContent = unique;
    dupCountEl.textContent    = dups;
  }

  function setStatusIdle() {
    statusBox.className = "status status-idle";
    statusMain.textContent = "Scanner idle";
    statusCode.textContent = "No scan yet.";
  }

  function setStatus(code, isDuplicate) {
    statusBox.className = "status " + (isDuplicate ? "status-dup" : "status-ok");
    statusMain.textContent = isDuplicate ? "Duplicate barcode" : "New barcode";
    statusCode.textContent = code || "—";
  }

  function onDetected(result) {
    if (!result || !result.codeResult || !result.codeResult.code) return;

    const now = Date.now();
    const code = result.codeResult.code.trim();

    // debounce same code in continuous frames
    if (lastCode === code && now - lastTime < SAME_CODE_DELAY) {
      return;
    }
    lastCode = code;
    lastTime = now;

    const prev = counts[code] || 0;

    // already counted duplicate once -> ignore extra
    if (prev >= 2) {
      return;
    }

    if (prev === 0) {
      // first time -> unique
      counts[code] = 1;
      saveToSession();
      updateCountsUI();
      setStatus(code, false);
      playBeep(false);
      return;
    }

    if (prev === 1) {
      // second time -> first duplicate
      counts[code] = 2;
      saveToSession();
      updateCountsUI();
      setStatus(code, true);
      playBeep(true);
      return;
    }
  }

  function startScanner() {
    if (isRunning) return;
    isRunning = true;
    btnStart.disabled = true;
    btnStop.disabled  = false;

    // remove old listeners before init
    try {
      Quagga.offDetected(onDetected);
    } catch (e) {}

    Quagga.init(
      {
        inputStream: {
          type: "LiveStream",
          target: document.querySelector("#interactive"),
          constraints: {
            facingMode: "environment",
            width:  { ideal: 1280 },
            height: { ideal: 720 },
            aspectRatio: { ideal: 1.777 },
            // Hint to browser for continuous / fast focus (not all browsers obey)
            advanced: [{ focusMode: "continuous" }]
          }
        },
        decoder: {
          readers: [
            // ONLY 1D readers that exist in Quagga2
            "code_128_reader",
            "code_39_reader",
            "ean_reader",
            "ean_8_reader",
            "upc_reader",
            "upc_e_reader",
            "codabar_reader"
          ]
        },
        locate: true,
        numOfWorkers: navigator.hardwareConcurrency
          ? Math.min(4, navigator.hardwareConcurrency)
          : 2
      },
      function (err) {
        if (err) {
          console.error(err);
          alert("Error initializing scanner: " + err);
          isRunning = false;
          btnStart.disabled = false;
          btnStop.disabled = true;
          return;
        }
        Quagga.start();
        statusBox.className = "status status-idle";
        statusMain.textContent = "Scanning…";
        statusCode.textContent = "Point camera at 1D barcode.";
        Quagga.onDetected(onDetected);
      }
    );
  }

  function stopScanner() {
    if (!isRunning) return;
    isRunning = false;
    btnStart.disabled = false;
    btnStop.disabled  = true;
    try {
      Quagga.stop();
      Quagga.offDetected(onDetected);
    } catch (e) {
      console.warn("Error stopping Quagga", e);
    }
    setStatusIdle();
  }

  function showDuplicateCodes() {
    const dups = Object.keys(counts).filter(code => counts[code] >= 2);
    if (!dups.length) {
      alert("No duplicate barcodes yet.");
      return;
    }
    const lines = dups.map(code => `${code} (scan count: ${counts[code]})`);
    alert("Duplicate barcodes:\n\n" + lines.join("\n"));
  }

  function clearAll() {
    if (!confirm("Clear all scanned barcodes for this session?")) return;
    counts = {};
    saveToSession();
    updateCountsUI();
    setStatusIdle();
  }

  btnStart.addEventListener("click", startScanner);
  btnStop.addEventListener("click",  stopScanner);
  btnShowDup.addEventListener("click", showDuplicateCodes);
  btnClear.addEventListener("click",   clearAll);

  // init
  loadFromSession();
  setStatusIdle();
</script>
</body>
</html>
